#!/usr/bin/env bash
set -eo pipefail

# -----> Heroku receiving push
# -----> Updating alpha language packs... done
# -----> Ruby app detected
# -----> Installing dependencies using Bundler version 1.1.pre.8
#        Running: bundle install --without development:test --path vendor/bundle --deployment
#        The Gemfile specifies no dependencies
#        Your bundle is complete! It was installed into ./vendor/bundle
#        Cleaning up the bundler cache.
# -----> Discovering process types
#        Procfile declares types -> receive
#        Default types for Ruby  -> console, rake
# -----> Compiled slug size is 344K
# -----> Launching... done, v2
#        http://radiant-planet-875.herokuapp.com deployed to Heroku

GIT_DIR=$(pwd)
TMP_DIR=$(mktemp -d /tmp/app.XXXXX)
BUILD_DIR=$TMP_DIR/app

topic()   { echo "----->" $*; }
err()     { echo " !    " $*; }

trap "rm -rf $TMP_DIR" EXIT

read oldrev newrev ref

topic Heroku receiving push
mkdir -p $BUILD_DIR
git --work-tree=$BUILD_DIR checkout -f $newrev 2> /dev/null

topic Updating language pack...
git clone git://gist.github.com/1210141.git $TMP_DIR/lp > /dev/null

# compile app in a clean environment (rvm necessitates preserving MY_RUBY_HOME)
env -i MY_RUBY_HOME=$MY_RUBY_HOME \
  $TMP_DIR/lp/bin/compile $TMP_DIR/app $TMP_DIR/cache

[ $? -ne 0 ] && { err Heroku push rejected, failed to compile app; exit 1; }

# release
env -i $TMP_DIR/lp/bin/release $TMP_DIR/app > $TMP_DIR/release.yml

# squash
mksquashfs $BUILD_DIR $TMP_DIR/slug.img -all-root > /dev/null
topic Compiled slug is $(du -h $TMP_DIR/slug.img | cut -f1-1)

# push
export HEROKU_HOST=heroku.com
export HEROKU_USERNAME=noah@heroku.com
export HEROKU_PASSWORD=bbcafa4b10423fa62db4bb11d0199853
$APP_ROOT/bin/heroku push --app herokuapp --slug $TMP_DIR/slug.img --release $TMP_DIR/release.yml
