#!/usr/bin/env bash -exo pipefail

GIT_DIR=$(pwd)
TMP_DIR=$(mktemp -d /tmp/app.XXXXX)

topic()   { echo "----->" $*; }
err()     { echo " !    " $*; }

trap "rm -rf $TMP_DIR" EXIT

while read oldrev newrev ref; do
  echo "STARTING [$oldrev $newrev $ref]"
done

topic Updating language pack...
(
  git clone $GIT_DIR $TMP_DIR/app
  git clone git@gist.github.com:28bcc3505ac18b9d6885.git $TMP_DIR/lp
) > /dev/null

$TMP_DIR/lp/bin/compile $TMP_DIR/app $TMP_DIR/cache
STATUS=$?

[ $STATUS -ne 0 ] && err Heroku push rejected, failed to compile app
exit $STATUS